{% extends 'projects/base.html' %}
{% load static %}

{% block content %}

<h3 class="mb-3">Overview</h3>

<div class="row g-4">
    {% for objs in resources %}
    <div class="col-12 col-xl-6 d-flex">
        <div class="card w-100 shadow border-0">
            <div class="card-header bg-white d-flex align-items-center justify-content-between py-3"
                style="min-height: 5rem;">
                <h5 class="card-title mb-0">{{ objs.title }}</h5>

                <div class="dropdown show">
                    <a href="#" class="btn shadow-sm" data-bs-toggle="dropdown" data-display="static"
                        aria-expanded="false">
                        New
                    </a>

                    <div class="dropdown-menu dropdown-menu-right">
                        {% for app in objs.apps %}
                        {% include './create_app_link.html' %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% if objs.objs %}
            <div class="no-footer">

                <table id="datatables-dashboard-projects-{{ forloop.counter }}"
                    class="table table-striped my-0 no-footer" role="grid">
                    <thead>
                        <tr>
                            <th class="d-none d-xxl-table-cell " tabindex="0" rowspan="1" colspan="1"></th>
                            <th tabindex="0" rowspan="1" colspan="1">App</th>
                            <th tabindex="0" rowspan="1" colspan="1">Name</th>
                            <th class="d-none d-xxl-table-cell " tabindex="0" rowspan="1" colspan="1">Created</th>
                            <th class="" tabindex="0" rowspan="1" colspan="1">Status</th>
                            <th class="d-none d-md-table-cell " tabindex="0" rowspan="1" colspan="1">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obj in objs.objs %}
                        <tr class="odd">

                            {% static 'images/logos/apps/' as static_url %}
                            <td><img src="{{static_url}}{{obj.app.logo|default:'default-logo.png'}}" class="img-fluid "
                                    alt="App Logo" style="max-height:25px;"></td>
                            <td class="d-none d-xxl-table-cell">{{ obj.app.name }}</td>
                            {% if obj.table_field.url %}
                            <td class="sorting_1">
                                <a href="{{ obj.table_field.url }}" target="_blank">
                                    {{obj.name}} <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </td>
                            {% else %}
                            <td class="sorting_1">{{ obj.name }}</td>
                            {% endif %}
                            <td class="d-none d-xxl-table-cell">{{ obj.created_on | date:"d/n/y H:i" }}</td>
                            <td id="status-{{ obj.pk }}">
                                <span class="badge bg-secondary">
                                    {{ obj.status.latest.status_type }}
                                </span>
                            </td>
                            <td class="table-action text-center">
                                <div class="dropdown show">
                                    <a href="#" class="default" data-bs-toggle="dropdown" data-display="static">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item disabled default"
                                            href="{% url 'apps:logs' request.user project.slug obj.pk %}">
                                            <i class="bi bi-activity me-1"></i>
                                            Logs (disabled)
                                        </a>

                                        {% if obj.app.user_can_edit %}

                                        <a class="dropdown-item default"
                                            href="{% url 'apps:appsettings' request.user project.slug obj.pk %}?from=overview">
                                            <i class="bi bi-sliders2-vertical me-1"></i>
                                            Settings
                                        </a>
                                        {% else %}

                                        <a class="dropdown-item default disabled">
                                            <i class="bi bi-sliders2-vertical me-1"></i>
                                            Settings
                                        </a>
                                        {% endif %}

                                        {% if obj.app.user_can_delete %}

                                        <a class="dropdown-item bg-danger text-white confirm-delete default"
                                            href="{% url 'apps:delete' request.user project.slug obj.app.category.slug obj.pk %}?from=overview">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                        {% else %}

                                        <a class="dropdown-item bg-danger text-white confirm-delete default disabled">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="h-100 p-4 d-flex align-items-center justify-content-center">
                <p>No instances.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    <div class="col-12 col-xl-6 d-flex">
        <div class="card w-100 shadow border-0">
            <div class="bg-white py-3 card-header d-flex justify-content-between align-items-center"
                style="min-height: 5rem;">

                <h5 class="card-title mb-0">Models</h5>
            </div>
            {% if models %}
            <div class="no-footer">

                <table id="datatables-dashboard-projects" class="table table-striped my-0 no-footer" role="grid">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th class="d-none d-xxl-table-cell" scope="col">
                                Version</th>
                            <th class="d-none d-xxl-table-cell" scope="col">
                                Created</th>
                            <th scope="col">Status</th>
                            <th class="d-none d-md-table-cell" scope="col">
                                Accessability</th>
                            <th class="d-none d-md-table-cell" scope="col">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in models %}
                        <tr class="odd">
                            <td class="sorting_1">{{ model.name }}</td>
                            <td class="d-none d-xxl-table-cell">{{ model.version }}</td>
                            <td class="d-none d-xxl-table-cell">{{ model.uploaded_at }}</td>
                            <td><span class="badge 
                                        {% if model.status == 'CR' %}bg-warning
                                        {% elif model.status == 'DP' %}bg-success
                                        {% elif model.status == 'AR' %}bg-danger
                                        {% endif %}">{{ model.get_status_display }}</span></td>
                            <td class="d-none d-md-table-cell">{{ model.get_access_display }}</td>
                            <td class="table-action text-center">
                                <div class="dropdown show">
                                    <a href="#" data-bs-toggle="dropdown" data-display="static">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item default"
                                            href="{% url 'models:details_private' request.user project.slug model.pk %}">
                                            <i class="bi bi-text-center me-1"></i>
                                            Details
                                        </a>

                                        {% if model.access != "PU" %}
                                        <a class="dropdown-item default"
                                            href="{% url 'models:publish_model' request.user project.slug model.id %}">
                                            <i class="bi bi-share me-1"></i>
                                            Publish
                                        </a>
                                        {% else %}
                                        <a class="dropdown-item default"
                                            href="{% url 'models:unpublish_model' request.user project.slug model.id %}">
                                            <i class="bi bi-slash-circle me-1"></i>
                                            Unpublish
                                        </a>
                                        {% endif %}

                                        {% include 'common/serve_model_link.html' %}

                                        <a class="dropdown-item default bg-danger text-white confirm-delete"
                                            href="{% url 'models:delete' request.user project.slug model.pk %}">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}

                <div class="h-100 p-4 d-flex align-items-center justify-content-center">
                    <p>No models have been uploaded to this project yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        {
            const apps = JSON.parse("{{ app_ids|escapejs }}")

            const body = new FormData()
            body.append("apps", apps)

            const url = "{% url 'apps:get_status' request.user project.slug %}"
            const csrftoken = getCookie('csrftoken');

            const updateStatus = async () => {

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body
                })

                const json = await response.json()

                for (const key in json) {
                    if (Object.hasOwnProperty.call(json, key)) {

                        const { status, statusGroup } = json[key]
                        const querySelector = `#status-${key} > span`
                        const element = document.querySelector(querySelector)
                        const className = `badge bg-${statusGroup}`

                        element.className = className
                        element.innerText = status
                    }
                }
            }

            const loop = async () => {

                if ((apps?.length ?? 0) > 0) {

                    await updateStatus()

                    setTimeout(() => {
                        loop()
                    }, 5000)
                }
            }

            loop()
        }
    </script>

    {% endblock %}